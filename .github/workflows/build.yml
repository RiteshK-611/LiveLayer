name: Build & Release LiveLayer

on:
  push:
    branches: [main]

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Install dependencies
        run: npm install

      # --- Extract version from package.json ---
      - name: Extract version from package.json
        id: version
        shell: bash
        run: |
          version=$(node -p "require('./package.json').version")
          tag="v$version"
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "Version: $version"
          echo "Tag: $tag"

      # --- Build the app (includes .exe, .msi, .msix) ---
      - name: Build LiveLayer (Tauri)
        run: npm run tauri build

      - name: Get Artifacts Paths
        id: artifacts
        shell: bash
        run: |
          msi=$(ls target/release/bundle/msi/*.msi | head -n 1 || true)
          exe=$(ls target/release/bundle/nsis/*.exe | head -n 1 || true)
          msix=$(ls target/release/bundle/msix/*.msix | head -n 1 || true)
          echo "msi=$msi" >> $GITHUB_OUTPUT
          echo "exe=$exe" >> $GITHUB_OUTPUT
          echo "msix=$msix" >> $GITHUB_OUTPUT
          echo "MSI: $msi"
          echo "EXE: $exe"
          echo "MSIX: $msix"

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveLayer-MSI
          path: ${{ steps.artifacts.outputs.msi }}

      - name: Upload EXE Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveLayer-EXE
          path: ${{ steps.artifacts.outputs.exe }}

      - name: Upload MSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LiveLayer-MSIX
          path: ${{ steps.artifacts.outputs.msix }}

      # --- Create Draft GitHub Release with Artifacts ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: LiveLayer ${{ steps.version.outputs.tag }}
          body: |
            ## ðŸŽ¨ LiveLayer ${{ steps.version.outputs.version }}

            LiveLayer brings beautiful wallpapers and a clock overlay to your desktop.

            ### âœ¨ Features
            - **Dynamic Wallpapers**: Support for images, videos, and GIFs
            - **Live Wallpapers**: Video wallpapers that play behind your desktop
            - **Date Widget**: Customizable desktop date widget with multiple fonts
            - **Auto-Change**: Randomized slideshow functionality
            - **System Tray**: Minimize to system tray for seamless operation
            - **Cross-Platform**: Windows, macOS, and Linux support

            ### ðŸ“¥ Download
            - **Windows Installer (Recommended)**: `LiveLayer_${{ steps.version.outputs.version }}_x64-setup.exe`
            - **Windows MSI**: `LiveLayer_${{ steps.version.outputs.version }}_x64_en-US.msi`
            - **Microsoft Store Package (MSIX)**: `LiveLayer_${{ steps.version.outputs.version }}_x64_en-US.msix`

            ### ðŸ’» System Requirements
            - **Windows**: Windows 10 or later
            - **macOS**: macOS 10.15 or later  
            - **Linux**: Modern Linux distribution with X11 or Wayland

            ### ðŸš€ Installation
            
            **For EXE/MSI installers:**
            1. Download the appropriate installer for your system
            2. Run the installer and follow the setup wizard
            3. Launch LiveLayer from your applications menu

            **For MSIX (Microsoft Store):**
            - The MSIX package is ready for submission to the Microsoft Store
            - For local testing, see: https://learn.microsoft.com/en-us/windows/msix/package/packaging-uwp-apps#install-your-app-package

            ---

            **Full Changelog**: https://github.com/riteshk-611/livelayer/commits/${{ steps.version.outputs.tag }}
          prerelease: false
          files: |
            ${{ steps.artifacts.outputs.msi }}
            ${{ steps.artifacts.outputs.exe }}
            ${{ steps.artifacts.outputs.msix }}